<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Fire Map Randomizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .map-card {
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
        }
        .map-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.4);
        }
        .map-checkbox:checked + label {
            border-color: #f97316;
            box-shadow: 0 0 25px rgba(249, 115, 22, 0.6);
        }
        .map-checkbox:checked + label .overlay {
            opacity: 0.75;
        }
        .map-checkbox:checked + label .checkmark {
            opacity: 1;
        }
        .map-card-name-selected {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .map-checkbox:checked + label .map-card-name-selected {
            opacity: 1;
            transform: translateY(0);
        }
        .result-card {
            transition: transform 0.7s ease;
        }
        .result-card.revealed {
            transform: rotateY(180deg);
        }
        .result-card .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .result-card .card-back {
            transform: rotateY(180deg);
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .locked-in {
            box-shadow: 0 0 15px 3px rgba(249, 115, 22, 0.7), inset 0 0 10px rgba(249, 115, 22, 0.4);
            border: 2px solid #f97316;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-slate-800 text-white antialiased">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <!-- Referee View -->
        <div id="referee-view" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-orange-500 text-shadow">Referee Control Panel</h1>
                <p class="text-gray-400 mt-2">Setup the tournament and randomize maps</p>
            </header>

            <!-- Setup Section -->
            <div id="setup-section" class="bg-slate-900/50 p-6 rounded-2xl shadow-2xl mb-8 ring-1 ring-white/10 backdrop-blur-sm">
                <h2 class="text-2xl font-bold mb-4 border-b-2 border-slate-700 pb-2">1. Tournament Setup</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="tournament-title" class="block mb-2 font-medium text-gray-300">Tournament Name</label>
                        <input type="text" id="tournament-title" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-orange-500 focus:outline-none" placeholder="e.g., Free Fire Pro League Season X">
                    </div>
                    <div>
                        <label for="game-count" class="block mb-2 font-medium text-gray-300">Total Number of Games</label>
                        <input type="number" id="game-count" min="1" max="10" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-orange-500 focus:outline-none" placeholder="Enter number of games (Max 10)">
                    </div>
                </div>

                <h3 class="text-xl font-bold mt-6 mb-4">Select maps to use (Max 6 maps)</h3>
                <div id="map-selection" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                    <!-- Map checkboxes will be injected here by JS -->
                </div>

                <div class="mt-8 text-center">
                    <button id="setup-button" class="btn bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg">
                        Setup & Start Tournament
                    </button>
                </div>
            </div>

            <!-- Control Section -->
            <div id="control-section" class="hidden bg-slate-900/50 p-6 rounded-2xl shadow-2xl ring-1 ring-white/10 backdrop-blur-sm">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h2 id="display-tournament-title" class="text-3xl font-bold text-orange-400 text-shadow"></h2>
                    <div class="flex items-center space-x-4 mt-4 md:mt-0">
                         <button id="reset-button" class="btn bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                            Reset All
                        </button>
                         <button id="copy-link-button" class="btn bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                            Copy Link for Teams
                        </button>
                    </div>
                </div>
                
                <div class="text-center mb-8">
                    <button id="randomize-button" class="btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 px-10 text-xl rounded-lg shadow-xl disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed disabled:transform-none">
                        Randomize Next Game
                    </button>
                    <p id="next-game-info" class="text-gray-400 mt-2"></p>
                </div>

                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Result cards will be injected here -->
                </div>
            </div>
        </div>

        <!-- Team View -->
        <div id="team-view" class="hidden">
            <header class="text-center mb-8">
                <h1 id="team-view-title" class="text-4xl md:text-5xl font-bold text-orange-500 text-shadow"></h1>
                <p class="text-gray-400 mt-2">Map Randomizer Results</p>
            </header>
            <div id="team-results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 <!-- Team result cards will be injected here -->
            </div>
             <div id="team-waiting-message" class="text-center py-16">
                <p class="text-2xl text-gray-500">Waiting for referee setup...</p>
            </div>
        </div>
        
        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
            Link copied successfully!
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // --- CONFIGURATION ---
                STORAGE_KEY: 'ff_map_randomizer_state_en_v13',
                // All available maps. Using official Free Fire links.
                ALL_MAPS: [
                    { id: 'bermuda', name: 'Bermuda', img: 'https://dl.dir.freefiremobile.com/common/Local/TH/CommuTournament/map/Bermuda.jpg' },
                    { id: 'purgatory', name: 'Purgatory', img: 'https://dl.dir.freefiremobile.com/common/Local/TH/CommuTournament/map/Purgatory.jpg' },
                    { id: 'kalahari', name: 'Kalahari', img: 'https://dl.dir.freefiremobile.com/common/Local/TH/CommuTournament/map/kalahari.jpg' },
                    { id: 'alpine', name: 'Alpine', img: 'https://dl.dir.freefiremobile.com/common/Local/TH/CommuTournament/map/Alpine.jpg' },
                    { id: 'nexterra', name: 'NeXTerra', img: 'https://dl.dir.freefiremobile.com/common/Local/TH/CommuTournament/map/Nexterra.jpg' },
                    { id: 'solara', name: 'Solara', img: 'https://dl.dir.freefiremobile.com/common/Local/TH/CommuTournament/map/solara.jpg' },
                ],

                // --- STATE ---
                state: {
                    tournamentTitle: '',
                    totalGames: 0,
                    initialMaps: [],
                    remainingMaps: [],
                    results: [],
                    isSetup: false,
                },
                animationRunning: false,

                // --- UI ELEMENTS ---
                ui: {
                    refereeView: document.getElementById('referee-view'),
                    teamView: document.getElementById('team-view'),
                    setupSection: document.getElementById('setup-section'),
                    controlSection: document.getElementById('control-section'),
                    mapSelection: document.getElementById('map-selection'),
                    tournamentTitleInput: document.getElementById('tournament-title'),
                    gameCountInput: document.getElementById('game-count'),
                    setupButton: document.getElementById('setup-button'),
                    resetButton: document.getElementById('reset-button'),
                    copyLinkButton: document.getElementById('copy-link-button'),
                    randomizeButton: document.getElementById('randomize-button'),
                    resultsGrid: document.getElementById('results-grid'),
                    teamResultsGrid: document.getElementById('team-results-grid'),
                    displayTournamentTitle: document.getElementById('display-tournament-title'),
                    teamViewTitle: document.getElementById('team-view-title'),
                    teamWaitingMessage: document.getElementById('team-waiting-message'),
                    nextGameInfo: document.getElementById('next-game-info'),
                    toast: document.getElementById('toast'),
                },

                // --- INITIALIZATION ---
                init() {
                    this.loadState();
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('view') === 'team') {
                        this.initTeamView();
                    } else {
                        this.initRefereeView();
                    }
                    window.addEventListener('storage', (e) => {
                        if (e.key === this.STORAGE_KEY) {
                            this.loadState();
                            this.updateTeamView();
                        }
                    });
                },

                // --- STATE MANAGEMENT ---
                saveState() {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state));
                },

                loadState() {
                    const savedState = localStorage.getItem(this.STORAGE_KEY);
                    if (savedState) {
                        this.state = JSON.parse(savedState);
                    } else {
                        // If no state is found in storage (e.g., after a reset), reset the in-memory state.
                        this.state = {
                            tournamentTitle: '',
                            totalGames: 0,
                            initialMaps: [],
                            remainingMaps: [],
                            results: [],
                            isSetup: false,
                        };
                    }
                },

                resetState() {
                    if(confirm('Are you sure you want to reset the entire tournament? All data will be lost.')) {
                        // Remove the item from storage. This triggers the 'storage' event for other tabs.
                        localStorage.removeItem(this.STORAGE_KEY);

                        // Also reset the state for the current (referee) view.
                        this.loadState(); // This will reset the state object to default
                        
                        // Update the referee UI immediately.
                        this.updateRefereeView(false);
                    }
                },

                // --- REFEREE VIEW LOGIC ---
                initRefereeView() {
                    this.ui.refereeView.style.display = 'block';
                    this.populateMapSelection();
                    this.ui.setupButton.addEventListener('click', this.handleSetup.bind(this));
                    this.ui.resetButton.addEventListener('click', this.resetState.bind(this));
                    this.ui.copyLinkButton.addEventListener('click', this.copyTeamLink.bind(this));
                    this.ui.randomizeButton.addEventListener('click', this.randomizeNextMap.bind(this));
                    this.updateRefereeView(false);
                },

                populateMapSelection() {
                    this.ui.mapSelection.innerHTML = '';
                    this.ALL_MAPS.forEach(map => {
                        const mapElement = `
                            <div class="relative">
                                <input type="checkbox" id="map-${map.id}" value='${JSON.stringify(map)}' class="map-checkbox absolute opacity-0 w-0 h-0">
                                <label for="map-${map.id}" class="map-card cursor-pointer block border-4 border-transparent rounded-lg overflow-hidden relative aspect-video">
                                    <div class="w-full h-full" style="background-image: url('${map.img}'); background-size: cover; background-position: center;"></div>
                                    <div class="overlay absolute inset-0 bg-black opacity-50 transition-opacity duration-300"></div>
                                    
                                    <!-- Name that appears on selection -->
                                    <div class="absolute inset-0 flex items-center justify-center p-2">
                                        <h4 class="map-card-name-selected text-3xl font-bold text-white uppercase text-shadow">${map.name}</h4>
                                    </div>

                                    <!-- Permanent label at the bottom -->
                                    <div class="absolute bottom-0 left-0 w-full p-1 bg-black/60">
                                        <p class="text-white text-center text-xs font-bold uppercase tracking-wider">${map.name}</p>
                                    </div>

                                    <div class="checkmark absolute top-2 right-2 w-6 h-6 bg-orange-500 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-300">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                    </div>
                                </label>
                            </div>
                        `;
                        this.ui.mapSelection.insertAdjacentHTML('beforeend', mapElement);
                    });
                },

                handleSetup() {
                    const title = this.ui.tournamentTitleInput.value.trim();
                    const games = parseInt(this.ui.gameCountInput.value);
                    const selectedMaps = Array.from(document.querySelectorAll('.map-checkbox:checked')).map(cb => JSON.parse(cb.value));

                    if (!title) {
                        alert('Please enter a tournament name');
                        return;
                    }
                    if (isNaN(games) || games <= 0 || games > 10) {
                        alert('Please enter a valid number of games (1-10)');
                        return;
                    }
                    if (selectedMaps.length === 0) {
                        alert('Please select at least one map');
                        return;
                    }
                     if (selectedMaps.length > 6) {
                        alert('You can select a maximum of 6 maps');
                        return;
                    }
                    if (games > selectedMaps.length && games < 7) {
                        alert(`The number of games (${games}) cannot be greater than the number of selected maps (${selectedMaps.length}) unless it's 7 or more.`);
                        return;
                    }

                    this.state = {
                        tournamentTitle: title,
                        totalGames: games,
                        initialMaps: [...selectedMaps],
                        remainingMaps: [...selectedMaps],
                        results: [],
                        isSetup: true,
                    };

                    this.saveState();
                    this.updateRefereeView(false);
                },

                updateRefereeView(isNewRandom) {
                    if (this.state.isSetup) {
                        this.ui.setupSection.style.display = 'none';
                        this.ui.controlSection.style.display = 'block';
                        this.ui.displayTournamentTitle.textContent = this.state.tournamentTitle;
                        this.renderGrid(this.ui.resultsGrid, false); // Referee view always renders instantly
                        this.updateRandomizeButton();
                    } else {
                        this.ui.setupSection.style.display = 'block';
                        this.ui.controlSection.style.display = 'none';
                        this.ui.tournamentTitleInput.value = '';
                        this.ui.gameCountInput.value = '';
                        document.querySelectorAll('.map-checkbox').forEach(cb => cb.checked = false);
                        this.ui.resultsGrid.innerHTML = '';
                    }
                },
                
                updateRandomizeButton() {
                    const nextGameNumber = this.state.results.length + 1;
                    if (this.animationRunning || nextGameNumber > this.state.totalGames) {
                        this.ui.randomizeButton.disabled = true;
                        if (nextGameNumber > this.state.totalGames) {
                           this.ui.nextGameInfo.textContent = 'The tournament has ended!';
                        }
                    } else {
                        this.ui.randomizeButton.disabled = false;
                        this.ui.nextGameInfo.textContent = `Click to randomize map for Game ${nextGameNumber}`;
                    }
                },

                async randomizeNextMap() {
                    if (this.animationRunning) return;
                    this.animationRunning = true;
                    this.updateRandomizeButton();

                    const nextGameNumber = this.state.results.length + 1;

                    // --- Pool Reset Logic ---
                    if (nextGameNumber === 7) {
                        this.state.remainingMaps = [...this.state.initialMaps];
                        this.showToast('Map pool has been reset!', 'bg-blue-500');
                    }
                    if (this.state.remainingMaps.length === 0) {
                        this.state.remainingMaps = [...this.state.initialMaps];
                    }
                    
                    // --- Actual Randomization ---
                    const remaining = this.state.remainingMaps;
                    const randomIndex = Math.floor(Math.random() * remaining.length);
                    const selectedMap = remaining[randomIndex];

                    // --- Update State ---
                    this.state.results.push({
                        game: nextGameNumber,
                        map: selectedMap,
                    });
                    this.state.remainingMaps.splice(randomIndex, 1);
                    
                    // Save state so team view can pick up the change
                    this.saveState(); 

                    // --- Animate on referee view ---
                    const refereeCard = document.getElementById(`result-card-${nextGameNumber}`);
                    await this.runRandomizationAnimation(refereeCard, selectedMap);
                    
                    this.animationRunning = false;
                    this.updateRandomizeButton();
                },
                
                async runRandomizationAnimation(targetCardElement, finalMap) {
                    if (!targetCardElement) return Promise.resolve();

                    const cardBack = targetCardElement.querySelector('.card-back');
                    const mapNameEl = cardBack.querySelector('h3');
                    const animationDuration = 2500; // 2.5 seconds
                    const updateInterval = 80; // ms, faster for smoother feel
                    let startTime = null;
                    let animationFrameId = null;

                    // Flip the card instantly to the back
                    targetCardElement.style.transition = 'none';
                    targetCardElement.classList.add('revealed');

                    // Use remainingMaps for the animation reel
                    const reel = [...this.state.remainingMaps, finalMap, ...this.state.remainingMaps, finalMap].sort(() => 0.5 - Math.random());
                    let reelIndex = 0;
                    let lastUpdateTime = 0;

                    return new Promise(resolve => {
                        const animate = (timestamp) => {
                            if (!startTime) startTime = timestamp;
                            const elapsedTime = timestamp - startTime;

                            if (timestamp - lastUpdateTime > updateInterval) {
                                const currentMap = reel[reelIndex % reel.length];
                                cardBack.style.backgroundImage = `url('${currentMap.img}')`;
                                mapNameEl.textContent = currentMap.name;
                                reelIndex++;
                                lastUpdateTime = timestamp;
                            }

                            if (elapsedTime < animationDuration) {
                                animationFrameId = requestAnimationFrame(animate);
                            } else {
                                // Stop the animation and show the final result
                                cancelAnimationFrame(animationFrameId);
                                cardBack.style.backgroundImage = `url('${finalMap.img}')`;
                                mapNameEl.textContent = finalMap.name;
                                cardBack.classList.add('locked-in');
                                targetCardElement.style.transition = 'transform 0.7s ease';
                                resolve();
                            }
                        };
                        animationFrameId = requestAnimationFrame(animate);
                    });
                },

                renderGrid(container, isNewRandom) {
                    container.innerHTML = '';
                    const newGameNumber = this.state.results.length;

                    for (let i = 1; i <= this.state.totalGames; i++) {
                        const result = this.state.results.find(r => r.game === i);
                        const card = this.createResultCard(i, result);

                        if (result) {
                            // Reveal all cards instantly except the one being animated
                            if (!isNewRandom || result.game !== newGameNumber) {
                                card.style.transition = 'none';
                                card.classList.add('revealed');
                            }
                        }
                        container.appendChild(card);
                    }
                },

                createResultCard(gameNumber, result) {
                    const card = document.createElement('div');
                    card.className = 'result-card relative aspect-[16/10] [transform-style:preserve-3d]';
                    card.id = `result-card-${gameNumber}`;
                    
                    const mapName = result ? result.map.name : '???';
                    const mapImg = result ? result.map.img : 'https://placehold.co/400x200/454545/999999?text=%3F';
                    const isLocked = result ? 'locked-in' : '';
                    
                    card.innerHTML = `
                        <!-- Card Front (Hidden) -->
                        <div class="card-face card-front absolute w-full h-full bg-slate-800 rounded-xl flex flex-col items-center justify-center border-2 border-dashed border-slate-600 transition-all duration-200">
                            <span class="text-5xl font-bold text-slate-500">?</span>
                            <h3 class="text-xl font-bold text-slate-400 mt-2">Game ${gameNumber}</h3>
                        </div>
                        <!-- Card Back (Visible) -->
                        <div class="card-face card-back absolute w-full h-full rounded-xl overflow-hidden shadow-lg ${isLocked}" style="background-image: url('${mapImg}'); background-size: cover; background-position: center;">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <div class="absolute bottom-0 left-0 p-4 w-full">
                                <p class="text-gray-200 text-sm font-medium">Game ${gameNumber}</p>
                                <h3 class="text-xl font-bold text-white text-shadow uppercase whitespace-nowrap">${mapName}</h3>
                            </div>
                        </div>
                    `;
                    return card;
                },

                copyTeamLink() {
                    const url = new URL(window.location.href);
                    url.searchParams.set('view', 'team');
                    navigator.clipboard.writeText(url.href).then(() => {
                        this.showToast('Link copied successfully!', 'bg-green-500');
                    }).catch(err => {
                        console.error('Failed to copy link: ', err);
                        alert('Failed to copy link');
                    });
                },
                
                showToast(message, bgColor) {
                    const toast = this.ui.toast;
                    toast.textContent = message;
                    toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 ${bgColor}`;
                    
                    toast.classList.remove('translate-y-20', 'opacity-0');
                    toast.classList.add('translate-y-0', 'opacity-100');
                    setTimeout(() => {
                        toast.classList.remove('translate-y-0', 'opacity-100');
                        toast.classList.add('translate-y-20', 'opacity-0');
                    }, 3000);
                },

                // --- TEAM VIEW LOGIC ---
                initTeamView() {
                    this.ui.teamView.style.display = 'block';
                    this.updateTeamView();
                },

                async updateTeamView() {
                    if (this.animationRunning) return;

                    if (!this.state.isSetup) {
                        this.ui.teamResultsGrid.style.display = 'none';
                        this.ui.teamResultsGrid.innerHTML = ''; // Clear the grid
                        this.ui.teamWaitingMessage.style.display = 'block';
                        this.ui.teamViewTitle.textContent = 'Free Fire Map Randomizer';
                        return;
                    }
                    
                    this.ui.teamWaitingMessage.style.display = 'none';
                    this.ui.teamResultsGrid.style.display = 'grid';
                    this.ui.teamViewTitle.textContent = this.state.tournamentTitle;
                    
                    const revealedCount = this.ui.teamResultsGrid.querySelectorAll('.revealed').length;
                    const isNewRandom = revealedCount < this.state.results.length;

                    if (isNewRandom) {
                        this.animationRunning = true;
                        this.renderGrid(this.ui.teamResultsGrid, true);
                        const newGameNumber = this.state.results.length;
                        const finalMap = this.state.results[newGameNumber - 1].map;
                        const teamCard = document.querySelector(`#team-results-grid #result-card-${newGameNumber}`);
                        
                        await this.runRandomizationAnimation(teamCard, finalMap);
                        this.animationRunning = false;
                    } else if (this.ui.teamResultsGrid.children.length !== this.state.totalGames) {
                        // Handle setup/reset case
                        this.renderGrid(this.ui.teamResultsGrid, false);
                    }
                }
            };

            app.init();
        });
    </script>
</body>
</html>
